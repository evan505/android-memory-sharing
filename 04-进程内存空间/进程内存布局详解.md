# Android进程内存空间布局详解

## 32位进程内存布局 (0x00000000 - 0xFFFFFFFF)

```
0xFFFFFFFF  ┌─────────────────────┐
            │    Kernel Space     │  1GB (0xC0000000-0xFFFFFFFF)
            │   (不可访问用户)     │  系统调用、中断处理
0xC0000000  ├─────────────────────┤
            │                     │
            │    Stack (栈)       │  ↓ 向下增长
            │                     │  函数调用、局部变量
0xBFFFFFFF  ├─────────────────────┤
            │                     │
            │   Memory Mapping    │  共享库、mmap文件
            │      Region         │  anonymous memory
            │                     │
0x40000000  ├─────────────────────┤
            │                     │
            │    Heap (堆)        │  ↑ 向上增长  
            │                     │  malloc、new分配
            │                     │
0x10000000  ├─────────────────────┤
            │   Data Segment      │  已初始化全局变量
0x08048000  ├─────────────────────┤
            │   Text Segment      │  程序代码 (只读)
0x08000000  ├─────────────────────┤
            │                     │
            │    Reserved         │  NULL指针区域
            │                     │
0x00000000  └─────────────────────┘
```

## 64位进程内存布局优化

Android 7.0+支持64位后，地址空间大幅扩展到128TB理论空间：

```
0x7FFFFFFFFFFF  ┌─────────────────────┐
                │    Kernel Space     │  上半部分
0x8000000000000 ├─────────────────────┤
                │                     │
                │       Stack         │  更大的栈空间
                │                     │
                ├─────────────────────┤
                │   Memory Mapping    │  更灵活的内存映射
                │                     │
                ├─────────────────────┤
                │       Heap          │  更大的堆空间
                │                     │
                ├─────────────────────┤
                │    Data/Text        │  程序段
                │                     │
0x0000000000000 └─────────────────────┘
```

## 各内存段详细说明

### 1. Text Segment (代码段)
- **权限**: 只读 + 可执行 (r-x)
- **内容**: 
  - 编译后的机器代码
  - 字符串常量
  - 只读数据
- **共享**: 同一程序的多个进程间共享
- **大小**: 固定，加载时确定

### 2. Data Segment (数据段)
- **权限**: 读写 (rw-)
- **分类**:
  - **.data**: 已初始化的全局变量
  - **.bss**: 未初始化的全局变量 (零初始化)
- **大小**: 编译时确定

### 3. Heap (堆)
- **权限**: 读写 (rw-)
- **管理**: 
  - Java对象由ART管理
  - Native内存由malloc/free管理
- **增长方向**: 向上增长 (地址递增)
- **大小**: 动态调整，受dalvik.vm.heapsize限制

### 4. Memory Mapping Region
- **用途**:
  - 动态链接库 (.so文件)
  - 匿名内存映射 (anonymous mmap)
  - 文件映射 (file-backed mmap)
  - Anonymous Shared Memory (ashmem)
- **特点**: 按需分配，灵活管理

### 5. Stack (栈)
- **权限**: 读写 (rw-)
- **内容**:
  - 函数调用帧
  - 局部变量
  - 返回地址
- **增长方向**: 向下增长 (地址递减)
- **大小**: 通常8MB，可通过ulimit调整

## Android特有的内存区域

### ART Heap Space
```
┌─────────────────────────────────────────────────────────┐
│                    ART Managed Heap                    │
├─────────────────────────────────────────────────────────┤
│  Young Generation  │  Old Generation  │  Permanent Gen │
│                    │                  │                │
│  Eden | S0 | S1    │   Old Space      │  Method Area   │
└─────────────────────────────────────────────────────────┘
```

### Ashmem (Anonymous Shared Memory)
- Android特有的匿名共享内存机制
- 支持跨进程共享
- 支持内存回收（可被内核回收）
- 广泛用于图像、音频等大数据共享

### Binder Memory
- 用于进程间通信的内存区域
- 每个进程最多1MB-8KB的binder内存
- 内核空间和用户空间的映射

## 内存布局查看方法

### 1. 通过/proc/[pid]/maps查看
```bash
adb shell cat /proc/$(pidof com.example.app)/maps
```

### 2. 通过dumpsys meminfo
```bash
adb shell dumpsys meminfo com.example.app
```

### 3. 通过smaps获得详细信息
```bash
adb shell cat /proc/$(pidof com.example.app)/smaps
```